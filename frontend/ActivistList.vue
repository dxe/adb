<template>
  <adb-page :title="title" :description="description" wide>
    <div class="activist-list-filters form-inline">
      <input
        v-on:input="debounceSearchInput"
        class="form-control filter-margin"
        type="text"
        placeholder="Search Name"
      />

      <button class="btn-link" @click="toggleShowOptions('filters')" v-if="view != 'none'">
        <span v-if="showOptions !== 'filters'">+</span
        ><span v-if="showOptions === 'filters'">-</span> Filters
      </button>
      <button class="btn-link" id="colFilterBtn" @click="toggleShowOptions('columns')">
        <span v-if="showOptions !== 'columns'">+</span
        ><span v-if="showOptions === 'columns'">-</span> Columns
      </button>

      <span>&nbsp;&nbsp;&nbsp;&nbsp;<b>Total rows: </b></span>

      <span v-if="!loading" id="rowCount">0</span>

      <span v-if="loading"><i>Loading...</i></span>

      <span v-if="view == 'chapter_member_development'">
        &nbsp;&nbsp;&nbsp;&nbsp;
        <a class="btn btn-default" href="/csv/chapter_member_spoke">
          <span class="glyphicon glyphicon-download-alt"></span>&nbsp;&nbsp;Export CSV for Spoke
        </a>
      </span>

      <div v-if="showOptions === 'filters'">
        <div>
          <label>Zip Code:</label>

          <input
            v-on:input="debounceSearchLocationInput"
            class="form-control filter-margin"
            type="text"
            placeholder="Zipcode"
          />

          <label>Radius:</label>
          <select
            id="filterRadius"
            v-model="filterRadius"
            class="form-control filter-margin"
            v-on:input="debounceLocationRadiusInput"
          >
            <option value="1">1 mile</option>
            <option value="2">2 miles</option>
            <option value="3">3 miles</option>
            <option value="4">4 miles</option>
            <option value="5">5 miles</option>
            <option value="10">10 miles</option>
            <option value="25">25 miles</option>
            <option value="50">50 miles</option>
          </select>
        </div>

        <div v-if="view == 'all_activists' || view == 'activist_pool'">
          <label>Last Event From:</label>
          <input v-model="lastEventDateFrom" class="form-control filter-margin" type="date" />
        </div>
        <div v-if="view == 'all_activists' || view == 'activist_pool'">
          <label>Last Event To:</label>
          <input v-model="lastEventDateTo" class="form-control filter-margin" type="date" />
        </div>
        <div v-if="view === 'community_prospects'">
          <label>Interest:</label>
          <select id="filterInterest" v-model="filterInterest" class="form-control filter-margin">
            <option>All</option>
            <option>Sanctuary</option>
            <option>Community</option>
            <option>Outreach</option>
            <option>Protest</option>
            <option>Trainings</option>
          </select>
        </div>
      </div>

      <div v-if="showOptions === 'columns'">
        <div v-for="column in columns">
          <span v-if="column.header !== ''">
            <input type="checkbox" :id="column.header" v-model="column.enabled" />
            <label :for="column.header">{{ column.longHeader }}</label>
          </span>
        </div>
      </div>
    </div>
    <div id="hot-table-container">
      <HotTable
        ref="hot"
        :root="root"
        :settings="hotSettings"
        :data="activists"
        :height="height"
      ></HotTable>
    </div>
    <modal
      name="activist-options-modal"
      height="auto"
      classes="no-background-color no-top"
      @opened="modalOpened"
      @closed="modalClosed"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">{{ currentActivist.name }}</h2>
          </div>
          <div class="modal-body">
            <ul class="activist-options-body">
              <!-- <li>
                <a @click="showModal('connection-modal', currentActivist, activistIndex)">Add Maintenance Connection</a>
              </li> -->
              <li>
                <a @click="showModal('merge-activist-modal', currentActivist, activistIndex)"
                  >Merge Activist</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </modal>
    <modal
      name="merge-activist-modal"
      :height="650"
      classes="no-background-color"
      @opened="modalOpened"
      @closed="modalClosed"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h2 class="modal-title">Merge activist</h2></div>
          <div class="modal-body">
            <p>Merging activists is used to combine redundant activist entries</p>
            <p>Merging this activist does two things:</p>
            <ul>
              <li>
                all of this activist&#39;s attendance data will be merged into the target activist
              </li>
              <li>this activist will be hidden</li>
            </ul>
            <p>Non-attendance data (e.g. email, location, etc) is <strong>NOT</strong> merged.</p>
            <p>Merge {{ currentActivist.name }} into another activist:</p>
            <p>
              Target activist:
              <select
                id="merge-target-activist"
                class="filter-margin"
                style="min-width: 200px"
              ></select>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="hideModal">Close</button>
            <button
              type="button"
              v-bind:disabled="disableConfirmButton"
              class="btn btn-danger"
              @click="confirmMergeActivistModal"
              v-focus
            >
              Merge activist
            </button>
          </div>
        </div>
      </div>
    </modal>
    <modal
      name="hide-activist-modal"
      :height="400"
      classes="no-background-color"
      @opened="modalOpened"
      @closed="modalClosed"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h2 class="modal-title">Hide activist</h2></div>
          <div class="modal-body">
            <p>Are you sure you want to hide {{ currentActivist.name }}?</p>
            <p>
              Hiding an activist hides them from the activist list page but does not delete any
              event data associated with them. If this activist is a duplicate of another activist,
              you should merge them instead.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="hideModal">Close</button>
            <button
              type="button"
              v-bind:disabled="disableConfirmButton"
              class="btn btn-danger"
              @click="confirmHideActivistModal"
              v-focus
            >
              Hide activist
            </button>
          </div>
        </div>
      </div>
    </modal>
    <!-- <modal
       name="connection-modal"
       :height="400"
       classes="no-background-color"
       @opened="modalOpened"
       @closed="modalClosed"
       >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Add maintenance connection</h2>
          </div>
          <div class="modal-body">
            <p><b>WARNING: This feature is not yet available!</b></p>
            <br />
            <p>Activist ID: {{currentActivist.id}}</p>
            <p>Activist Name: {{currentActivist.name}}</p>
            <p>Connector: {{currentActivist.connector}}</p>
            <p>Date: <input id="connection-date" type="date"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="hideModal">Cancel</button>
          </div>
        </div>
      </div>
    </modal> -->
  </adb-page>
</template>

<script lang="ts">
import Vue from 'vue';
import vmodal from 'vue-js-modal';
import HotTable from './external/vue-handsontable-official/HotTable.vue';
import { rewriteSettings } from './external/vue-handsontable-official/helpers';
import AdbPage from './AdbPage.vue';
import { focus } from './directives/focus';
import { flashMessage } from './flash_message';
import { EventBus } from './EventBus';
import { initActivistSelect } from './chosen_utils';
import debounce from 'debounce';
import zipcodes from 'zipcodes';

Vue.use(vmodal);

interface Activist {
  id: number;
  name: string;
  activist_level: string;
  active: number;
  prospect_organizer: number;
  prospect_chapter_member: number;
  dev_interest: string;
  circle_interest: number;
  total_events: number;
  source: string;
  interest_date: string;
  facebook: string;

  // To appease our clunky sorting functions.
  // TODO(mdempsky): Remove.
  [key: string]: any;
}

interface Column {
  header: string;
  longHeader?: string;
  data: Handsontable.GridSettings;
  enabled: boolean;
}

function emailValidator(value: string, callback: Function) {
  // Create a delay between the validation, and the
  // resulting state of the Column. i.e. When the user
  // clicks away from the column (or hits enter) the row
  // will be saved if valid, or the focus will be sent back
  // to the invalid column; the timeout here makes for a smoother
  // UI transition whichever the result of the validation.
  setTimeout(function () {
    if (
      /^([0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*@(([0-9a-zA-Z])+([-\w]*[0-9a-zA-Z])*\.)+[a-zA-Z]{2,9})$/.test(
        value,
      )
    ) {
      callback(true);
    } else {
      callback(false);
    }
  }, 250);
}

function zipcodeRadius(zip: string[], radius: any) {
  // radius to check

  var allZipsInRadius: any[] = [];

  for (var i = 0; i < zip.length; i++) {
    var zipsInRadius = zipcodes.radius(zip[i], radius, false);
    allZipsInRadius = allZipsInRadius.concat(zipsInRadius); // need to add arr to arr
  }
  return allZipsInRadius;
}

function lookupZipcodes(input: string) {
  var hasNumber = /\d/;
  if (hasNumber.test(input)) {
    // probably a zip
    return [input];
  } else {
    // try to lookup zipcodes for city name
    var cityData = zipcodes.lookupByName(input, 'CA');
    let zips = cityData.map((a) => a.zip);
    return zips;
  }
}

function getDefaultColumns(view: string): Column[] {
  return [
    {
      header: '',
      data: {
        renderer: optionsButtonRenderer,
        readOnly: true,
        disableVisualSelection: true,
        colWidths: 35,
      },
      enabled: true,
    },
    // Standard activist fields
    {
      header: 'ID',
      longHeader: 'Activist ID',
      data: {
        type: 'numeric',
        data: 'id',
        readOnly: true,
        colWidths: 50,
      },
      enabled: false,
    },
    {
      header: 'Name',
      longHeader: 'Activist Name',
      data: {
        data: 'name',
        colWidths: 150,
      },
      enabled: true,
    },
    {
      header: 'SMS Name',
      longHeader: 'SMS Name (First Name or Nickname)',
      data: {
        data: 'preferred_name',
        colWidths: 90,
      },
      enabled: view === 'chapter_member_development',
    },
    {
      header: 'Notes',
      longHeader: 'Notes',
      data: {
        data: 'notes',
        colWidths: 100,
      },
      enabled:
        view === 'organizer_prospects' ||
        view === 'development' ||
        view === 'circle_member_prospects' ||
        view === 'chapter_member_development' ||
        view === 'chapter_member_prospects',
    },
    {
      header: 'Managing',
      longHeader: 'Managing',
      data: {
        data: 'dev_manager',
        colWidths: 100,
      },
      enabled: view === 'organizer_prospects',
    },
    {
      header: 'Points',
      longHeader: 'Leaderboard Points',
      data: {
        type: 'numeric',
        data: 'total_points',
        readOnly: true,
        colWidths: 50,
      },
      enabled: view === 'leaderboard' || view === 'action_team',
    },
    {
      header: 'Email',
      longHeader: 'Email',
      data: {
        data: 'email',
        colWidths: 150,
        validator: (email: string, cb: Function) => {
          // Allow saving empty email
          if (!email) {
            return cb(true);
          }

          emailValidator(email, (isValid: boolean) => {
            // Show invalid email error message
            if (!isValid) {
              flashMessage('Email field is invalid. Please provide a valid email address.', true);
            }

            return cb(isValid);
          });
        },
        allowInvalid: false,
      },
      enabled:
        view === 'all_activists' ||
        view === 'activist_pool' ||
        view === 'activist_recruitment' ||
        view === 'chapter_member_prospects' ||
        view === 'chapter_member_development' ||
        view === 'circle_member_prospects' ||
        view === 'community_prospects',
    },
    {
      header: 'Phone',
      longHeader: 'Phone Number',
      data: {
        data: 'phone',
        colWidths: 100,
      },
      enabled:
        view === 'community_prospects' ||
        view === 'all_activists' ||
        view === 'chapter_member_prospects' ||
        view === 'chapter_member_development',
    },
    {
      header: 'Birthday',
      longHeader: 'Birthday',
      data: {
        data: 'dob',
        colWidths: 100,
        type: 'date',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
      },
      enabled: view === 'all_activists',
    },
    {
      header: 'Street Address',
      longHeader: 'Street Address',
      data: {
        data: 'street_address',
        colWidths: 100,
      },
      enabled: false,
    },
    {
      header: 'City',
      longHeader: 'City',
      data: {
        data: 'city',
        colWidths: 100,
      },
      enabled: false,
    },
    {
      header: 'State',
      longHeader: 'State',
      data: {
        data: 'state',
        colWidths: 100,
      },
      enabled: false,
    },
    {
      header: 'Zip Code',
      longHeader: 'Zip Code',
      data: {
        data: 'location',
        colWidths: 100,
      },
      enabled: view === 'all_activists',
    },
    {
      header: 'Facebook',
      longHeader: 'Facebook URL',
      data: {
        data: 'facebook',
      },
      enabled:
        view === 'all_activists' || view === 'activist_recruitment' || view === 'activist_pool',
    },

    // {
    //  header: "Contacted Date",
    //  data: {
    //    data: "contacted_date",
    //    type: 'date',
    //    dateFormat: 'YYYY-MM-DD',
    //    correctFormat: true,
    //    colWidths: 100,
    //  },
    //  enabled: view === "activist_pool",
    // }, {
    //  header: "Interested",
    //  data: {
    //    data: "interested",
    //    colWidths: 100,
    //    type: 'dropdown',
    //    source: [
    //     "",
    //      "Yes",
    //      "No",
    //    ],
    //  },
    //  enabled: view === "activist_pool",
    // },

    // ActivistMembershipData
    // {
    //  header: "Recruitment Connection Date",
    //  data: {
    //    data: "meeting_date",
    //    type: 'date',
    //    dateFormat: 'YYYY-MM-DD',
    //    correctFormat: true,
    //    colWidths: 100,
    //  },
    //  enabled: view === "activist_pool",
    // },
    //{
    //  header: "Escalation",
    //  data: {
    //    data: "escalation",
    //    type: 'dropdown',
    //    colWidths: 100,
    //    source: [
    //      "",
    //      "Yes",
    //      "No",
    //    ],
    //  },
    //  enabled: view === "activist_recruitment",
    //},

    {
      header: 'Level',
      longHeader: 'Activist Level',
      data: {
        data: 'activist_level',
        colWidths: 140,
        type: 'dropdown',
        source: ['Supporter', 'Chapter Member', 'Organizer', 'Non-Local', 'Global Network Member'],
      },
      enabled:
        view === 'all_activists' ||
        view === 'activist_recruitment' ||
        view === 'leaderboard' ||
        view === 'action_team' ||
        view === 'organizer_prospects' ||
        view === 'chapter_member_prospects' ||
        view === 'chapter_member_development' ||
        view === 'circle_member_prospects',
    },

    {
      header: 'Source',
      longHeader: 'Source',
      data: {
        data: 'source',
        colWidths: 100,
      },
      enabled: view === 'community_prospects',
    },

    {
      header: 'Interest Date',
      longHeader: 'Date Interest Form Submitted',
      data: {
        type: 'date',
        data: 'interest_date',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
        readOnly: true,
      },
      enabled: view === 'circle_member_prospects' || view === 'community_prospects',
    },

    {
      header: 'Circle Interest',
      longHeader: 'Circle Interest',
      data: {
        type: 'dropdown',
        source: [true, false],
        data: 'circle_interest',
        colWidths: 80,
      },
      enabled: view === 'circle_member_prospects',
    },

    {
      header: 'Applied',
      longHeader: 'Application Date',
      data: {
        type: 'date',
        data: 'dev_application_date',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
        readOnly: true,
      },
      enabled: view === 'chapter_member_prospects' || view === 'organizer_prospects',
    },

    {
      header: 'Application',
      longHeader: 'Application Type',
      data: {
        data: 'dev_application_type',
        colWidths: 80,
        readOnly: true,
      },
      enabled: view === 'chapter_member_prospects' || view === 'organizer_prospects',
    },

    {
      header: 'Prsp. Ch. Mem.',
      longHeader: 'Prospective Chapter Member',
      data: {
        type: 'dropdown',
        source: [true, false],
        data: 'prospect_chapter_member',
        colWidths: 60,
      },
      enabled: view === 'chapter_member_prospects',
    },

    {
      header: 'Prsp. Organizer',
      longHeader: 'Prospective Organizer',
      data: {
        type: 'dropdown',
        source: [true, false],
        data: 'prospect_organizer',
        colWidths: 100,
      },
      enabled: view === 'organizer_prospects',
    },

    {
      header: 'Contacted',
      longHeader: 'Circle Membership: Date Contacted',
      data: {
        type: 'date',
        data: 'cir_first_email',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'circle_member_prospects',
    },

    {
      header: 'Interests',
      longHeader: 'Interests',
      data: {
        data: 'dev_interest',
        colWidths: 100,
      },
      enabled:
        view === 'organizer_prospects' ||
        view === 'circle_member_prospects' ||
        view === 'community_prospects',
    },
    {
      header: 'First Event',
      longHeader: 'First Event Attended',
      data: {
        data: 'first_event_name',
        readOnly: true,
        colWidths: 200,
      },
      enabled:
        view === 'activist_pool' ||
        view === 'activist_recruitment' ||
        view === 'leaderboard' ||
        view === 'community_prospects' ||
        view === 'study',
    },
    {
      header: 'Last Event',
      longHeader: 'Last Event Attended',
      data: {
        data: 'last_event_name',
        readOnly: true,
        colWidths: 200,
      },
      enabled: view === 'activist_recruitment' || view === 'leaderboard' || view === 'study',
    },
    {
      header: 'Last Circle',
      longHeader: 'Last Circle Attended',
      data: {
        data: 'last_circle',
        type: 'date',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        readOnly: true,
        colWidths: 100,
      },
      enabled: false,
    },
    {
      header: 'Total Events',
      longHeader: 'Total Events Attended',
      data: {
        type: 'numeric',
        data: 'total_events',
        readOnly: true,
        colWidths: 90,
      },
      enabled: view === 'leaderboard' || view === 'community_prospects' || view === 'study',
    },

    // {
    //   header: "Active",
    //   data: {
    //     type: "checkbox",
    //     data: "active",
    //     readOnly: true,
    //     colWidths: 55,
    //   },
    //   enabled: (view === "action_team"),
    // },
    {
      header: 'MPI',
      longHeader: 'MPI Status',
      data: {
        type: 'checkbox',
        data: 'mpi',
        readOnly: true,
        colWidths: 30,
      },
      enabled:
        view === 'action_team' ||
        view === 'activist_pool' ||
        view === 'activist_recruitment' ||
        view === 'all_activists' ||
        view === 'leaderboard' ||
        view === 'development' ||
        view === 'chapter_member_prospects' ||
        view === 'chapter_member_development' ||
        view === 'organizer_prospects' ||
        view === 'development',
    },

    {
      header: 'DA&C Current Month',
      longHeader: 'Has attended both a Direct Action & a Community event in the Current Month',
      data: {
        data: 'mpp_requirements',
        colWidths: 80,
        readOnly: true,
      },
      enabled: view === 'chapter_member_development',
    },

    {
      header: 'Coach',
      longHeader: 'Coach Name',
      data: {
        data: 'connector',
        colWidths: 125,
      },
      enabled: view === 'activist_pool' || view === 'action_team' || view === 'development',
    },
    {
      header: 'Last Maint. Coaching',
      longHeader: 'Last Maintenance Coaching',
      data: {
        type: 'date',
        data: 'last_connection',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
        readOnly: true,
      },
      enabled: view === 'development',
    },
    {
      header: 'Workshop',
      longHeader: 'Date Attended Training: Workshop',
      data: {
        type: 'date',
        data: 'training0',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled:
        view === 'action_team' ||
        view === 'chapter_member_prospects' ||
        view === 'organizer_prospects',
    },
    {
      header: 'Consent & Oppress',
      longHeader: 'Date Attended Training: Consent & Anti-Oppression',
      data: {
        type: 'date',
        data: 'training1',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'development' || view === 'organizer_prospects',
    },
    {
      header: 'Prpsful Cmnty',
      longHeader: 'Date Attended Training: Building Purposeful Communities',
      data: {
        type: 'date',
        data: 'training4',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'development' || view === 'organizer_prospects',
    },
    {
      header: 'Ldshp & Mgmt',
      longHeader: 'Date Attended Training: Leadership and Management',
      data: {
        type: 'date',
        data: 'training5',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'development' || view === 'organizer_prospects',
    },
    {
      header: 'Vision & Strat',
      longHeader: 'Date Attended Training: Vision and Strategy',
      data: {
        type: 'date',
        data: 'training6',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'development' || view === 'organizer_prospects',
    },

    {
      header: 'Consent Refresh',
      longHeader: 'Date Passed Consent Refresher Quiz',
      data: {
        type: 'date',
        data: 'consent_quiz',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: false,
    },

    {
      header: 'Tier 2',
      longHeader: 'Date Attended Training: Tier II Protest',
      data: {
        type: 'date',
        data: 'training_protest',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: false,
    },

    {
      header: 'Quiz',
      longHeader: 'Organizer: Quiz',
      data: {
        type: 'date',
        data: 'dev_quiz',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'organizer_prospects' || view === 'development',
    },

    {
      header: 'First Text',
      longHeader: 'Chapter Membership: Date First SMS Message Sent',
      data: {
        type: 'date',
        data: 'cm_first_email',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'chapter_member_prospects',
    },
    {
      header: 'Apprv. Email',
      longHeader: 'Chapter Membership: Date Approval Email Sent',
      data: {
        type: 'date',
        data: 'cm_approval_email',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: view === 'chapter_member_prospects' || view === 'chapter_member_development',
    },
    {
      header: 'MPI Email',
      longHeader: 'Chapter Membership: Date MPI Warning Email Sent',
      data: {
        type: 'date',
        data: 'cm_warning_email',
        dateFormat: 'YYYY-MM-DD',
        correctFormat: true,
        colWidths: 100,
      },
      enabled: false,
    },

    {
      header: 'Vision Wall',
      longHeader: 'Chapter Member: Added to Vision Wall',
      data: {
        data: 'vision_wall',
        colWidths: 80,
        type: 'dropdown',
        source: ['', 'Yes', 'Declined'],
      },
      enabled: view === 'chapter_member_development',
    },

    {
      header: 'Hiatus',
      longHeader: 'Hiatus',
      data: {
        type: 'checkbox',
        data: 'hiatus',
        colWidths: 50,
      },
      enabled: view === 'chapter_member_development',
    },

    {
      header: 'Close Ties',
      longHeader: 'Referral: Close Ties',
      data: {
        data: 'referral_friends',
        colWidths: 100,
      },
      enabled: false,
    },

    {
      header: 'Referral',
      longHeader: 'Referral: Encouraged to Apply',
      data: {
        data: 'referral_apply',
        colWidths: 100,
      },
      enabled: view === 'community_prospects',
    },

    {
      header: 'Referral Outlet',
      longHeader: 'Referral: How did you hear about us?',
      data: {
        data: 'referral_outlet',
        colWidths: 100,
      },
      enabled: false,
    },
    {
      header: 'Voting Agreement',
      longHeader: 'Has signed voting agreement',
      data: {
        type: 'checkbox',
        data: 'voting_agreement',
        colWidths: 50,
      },
      enabled: view === 'chapter_member_development',
    },
    {
      header: 'Discord ID',
      longHeader: 'Discord ID',
      data: {
        //type: 'numeric',
        data: 'discord_id',
        colWidths: 50,
      },
      enabled: false,
    },
    {
      header: 'Geo-Circle',
      longHeader: 'Geo-Circle Membership',
      data: {
        data: 'geo_circles',
        readOnly: true,
        colWidths: 100,
      },
      enabled: view === 'chapter_member_development',
    },
  ];
}

// Constants related to list ordering
// Corresponds to the constants DescOrder and AscOrder in model/activist.go
const DescOrder = 2;
const AscOrder = 1;

var previousSortData = {
  field: '',
  ascending: false,
};

// Uses previousSortData to determine whether the next sort should be
// ascending.
//
// If sortByDate is true, then the default is to sort by descending.
// Otherwise, the default is to sort by ascending.
function shouldSortByAscending(field: string, sortByDate: boolean) {
  if (field == previousSortData.field) {
    return !previousSortData.ascending;
  }

  if (sortByDate) {
    return false;
  }
  return true;
}

// Call this after every sort.
function setPreviousSortData(field: string, ascending: boolean) {
  previousSortData.field = field;
  previousSortData.ascending = ascending;
}

// Must be kept in sync with the list in model/model.go
// var statusOrder = {
//   "Current": 1,
//   "New": 2,
//   "Former": 3,
//   "No attendance": 4,
// };

// var activistLevelOrder = {
//   "activist" : 3,
//   "core_activist" : 2,
//   "organizer" : 1,
// };

(window as any).showOptionsModal = function (row: number) {
  EventBus.$emit('activist-show-options-modal', row);
};

function optionsButtonRenderer(
  instance: any,
  td: HTMLElement,
  row: number,
  col: number,
  prop: any,
  value: any,
  cellProperties: any,
) {
  td.innerHTML =
    '<button ' +
    'data-role="trigger" ' +
    'class="activist-options-btn btn btn-default btn-xs dropdown-toggle glyphicon glyphicon-option-horizontal" ' +
    'type="button" ' +
    'onclick="window.showOptionsModal(' +
    row +
    ')"></button>';
  return td;
}

function initialDateFromValue() {
  var d = new Date();
  var rawYear = d.getFullYear();
  var rawMonth = d.getMonth() + 1;

  var monthOffset = 2;
  rawMonth -= monthOffset;
  if (rawMonth <= 0) {
    // 12 + rawMonth will be the correct month from the previous year
    // because rawMonth is either 0 or negative at this point.
    rawMonth = 12 + rawMonth;
    rawYear -= 1;
  }

  var year = '' + rawYear;
  var month = rawMonth > 9 ? '' + rawMonth : '0' + rawMonth;

  var fromDate = year + '-' + month + '-01';
  return fromDate;
}

function initialDateToValue() {
  var d = new Date();
  // An ISO date looks like "2017-11-01T23:21:50.377Z", so we cut off
  // everything after the date.
  return d.toISOString().slice(0, 10);
}

function generateBooleanSortFn(field: string, ascending: boolean) {
  return function (a: Activist, b: Activist) {
    var order = a[field] === b[field] ? 0 : Number(a[field]) - Number(b[field]);
    if (ascending) {
      return order;
    }
    return -1 * order;
  };
}

function generateStringSortFn(field: string, ascending: boolean) {
  return function (a: Activist, b: Activist) {
    var order = a[field].toLowerCase() < b[field].toLowerCase() ? -1 : 1;
    if (ascending) {
      return order;
    }
    return -1 * order;
  };
}

function generateGenericSortFn(field: string, ascending: boolean) {
  return function (a: Activist, b: Activist) {
    var order = a[field] < b[field] ? -1 : 1;
    if (ascending) {
      return order;
    }
    return -1 * order;
  };
}

function generateDateSortFn(field: string, ascending: boolean) {
  return function (a: Activist, b: Activist) {
    // Always sort empty values to the bottom, no matter the
    // order.
    if (!a[field]) {
      return 1;
    }
    if (!b[field]) {
      return -1;
    }

    var valueA = new Date(a[field]).getTime();
    var valueB = new Date(b[field]).getTime();

    var order = valueA < valueB ? -1 : 1;

    if (ascending) {
      return order;
    }
    return -1 * order;
  };
}

export default Vue.extend({
  name: 'activist-list',
  props: {
    title: String,
    description: String,
    // `view` is the default view to show. It can be one of:
    // "all_activists", "leaderboard", "activist_pool",
    // "activist_recruitment", or "action_team"
    view: {
      type: String,
      /*validator(value) {
        var validViews = [
          'all_activists',
          'leaderboard',
          'activist_pool',
          'activist_recruitment',
          'action_team',
          'development',
        ];
        return validViews.indexOf(value) !== -1;
      },*/
    },
  },
  methods: {
    showOptionsModal(row: number) {
      var activist = this.activists[row];
      this.showModal('activist-options-modal', activist, row);
    },
    showModal(modalName: string, activist: Activist, index: number) {
      // Check to see if there's a modal open, and close it if so.
      if (this.currentModalName) {
        this.hideModal();
      }

      // Show the modal in the next tick so that this code runs after
      // vue has hidden the previous modal.
      Vue.nextTick(() => {
        this.currentActivist = activist;

        if (index != undefined) {
          this.activistIndex = index; // needed for updating activist
        } else {
          this.activistIndex = -1;
        }

        this.currentModalName = modalName;
        this.$modal.show(modalName);
      });
    },
    hideModal() {
      if (this.currentModalName) {
        this.$modal.hide(this.currentModalName);
      }
      this.currentModalName = '';
      this.activistIndex = -1;
      this.currentActivist = {} as Activist;
    },
    modalOpened() {
      // Add noscroll to body tag so it doesn't scroll while the modal
      // is shown.
      $(document.body).addClass('noscroll');
      this.disableConfirmButton = false;

      if (this.currentModalName == 'merge-activist-modal') {
        // For some reason, even though this function is supposed to
        // fire after the modal is visible on the dom, the modal isn't
        // there. Vue.nextTick doesn't work for some reason, so we're
        // just going to keep calling setTimeout until the modal shows
        // up.
        var interval: number;
        var fn = () => {
          if ($('#merge-target-activist')[0]) {
            clearInterval(interval);
            initActivistSelect('#merge-target-activist', this.currentActivist.name);
          }
        };
        interval = setInterval(fn, 50);
      }
    },
    modalClosed() {
      // Allow body to scroll after modal is closed.
      $(document.body).removeClass('noscroll');
    },
    removeActivist(id: number) {
      var activistIndex;
      for (var i = 0; i < this.allActivists.length; i++) {
        if (this.allActivists[i].id === id) {
          activistIndex = i;
        }
      }
      if (!activistIndex) {
        throw new Error("Couldn't find activist index for activist with id: " + id);
      }
      this.allActivists = this.allActivists
        .slice(0, activistIndex)
        .concat(this.allActivists.slice(activistIndex + 1));
    },
    confirmMergeActivistModal() {
      var targetActivistName = $('#merge-target-activist').val();
      if (!targetActivistName) {
        flashMessage('Must choose an activist to merge into', true);
        return;
      }

      this.disableConfirmButton = true;
      var currentActivistID = this.currentActivist.id;

      $.ajax({
        url: '/activist/merge',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          current_activist_id: currentActivistID,
          target_activist_name: targetActivistName,
        }),
        success: (data) => {
          this.disableConfirmButton = false;

          var parsed = JSON.parse(data);
          if (parsed.status === 'error') {
            flashMessage('Error: ' + parsed.message, true);
            return;
          }
          flashMessage(this.currentActivist.name + ' was merged into ' + targetActivistName);

          // Remove activist from list.
          //this.removeActivist(currentActivistID);

          //this.hideModal();

          // Force view to refresh in order to pick
          // up changes to target activist data.
          // TOOD: Handle this better. Perhaps return updated
          // activist from backend call.
          // This is necessary because it doesn't appear that
          // the Vue.js component is handling data refreshing
          // properly; e.g. the "facebook" field is not updated.
          location.reload();
        },
        error: (err) => {
          this.disableConfirmButton = false;

          console.warn(err.responseText);
          flashMessage('Server error: ' + err.responseText, true);
        },
      });
    },
    confirmHideActivistModal() {
      this.disableConfirmButton = true;
      var currentActivistID = this.currentActivist.id;

      $.ajax({
        url: '/activist/hide',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ id: currentActivistID }),
        success: (data) => {
          this.disableConfirmButton = false;

          var parsed = JSON.parse(data);
          if (parsed.status === 'error') {
            flashMessage('Error: ' + parsed.message, true);
            return;
          }
          flashMessage(this.currentActivist.name + ' was hidden');

          // Remove activist from list.
          this.removeActivist(currentActivistID);

          this.hideModal();
        },
        error: (err) => {
          this.disableConfirmButton = false;

          console.warn(err.responseText);
          flashMessage('Server error: ' + err.responseText, true);
        },
      });
    },
    loadActivists() {
      this.loading = true;

      $.ajax({
        url: '/activist/list',
        method: 'POST',
        data: JSON.stringify(this.listActivistsParameters()),
        success: (data) => {
          var parsed = JSON.parse(data);

          if (parsed.status === 'error') {
            flashMessage('Error: ' + parsed.message, true);
            return;
          }

          // status === "success"
          var activistList = parsed.activist_list;

          // frontend filtering

          if (this.view === 'community_prospects') {
            var selectedInterest = $('#filterInterest :selected').text();

            // only need to filer if an interest is selected
            if (selectedInterest != 'All' && selectedInterest != '' && selectedInterest != null) {
              var activistListFiltered;
              activistListFiltered = activistList.filter((el: Activist) => {
                return el.dev_interest.toLowerCase().indexOf(selectedInterest.toLowerCase()) != -1;
              });
              activistList = activistListFiltered;
            }
          }

          if (activistList !== null) {
            this.allActivists = activistList;
            this.loading = false;
          }
        },
        error: (err) => {
          console.warn(err.responseText);
          flashMessage('Server error: ' + err.responseText, true);
        },
      });
    },
    debounceLoadActivists: debounce(function (this: any) {
      this.loadActivists();
    }, 500),
    afterChangeCallback(changes: any[], source: string) {
      if (
        source !== 'edit' &&
        source !== 'CopyPaste.paste' &&
        source !== 'UndoRedo.undo' &&
        source !== 'UndoRedo.redo'
      ) {
        return;
      }
      for (var i = 0; i < changes.length; i++) {
        var change = changes[i];
        var columnIndex = change[0];
        var columnName = change[1];
        var previousData = change[2];
        var newData = change[3];

        var activist = this.activists[columnIndex];
        (function (change) {
          // TODO: use change?
          $.ajax({
            url: '/activist/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(activist),
            success: (data) => {
              var parsed = JSON.parse(data);
              if (parsed.status === 'error') {
                flashMessage('Error: ' + parsed.message, true);
                return;
              }
            },
            error: (err) => {
              console.warn(err.responseText);
              flashMessage('Server error: ' + err.responseText, true);
            },
          });
        })(change);
      }
    },
    setHOTHeight() {
      var hotContainer = document.getElementById('hot-table-container');
      if (!hotContainer) {
        this.height = 500;
        return;
      }
      var y = (hotContainer.getBoundingClientRect() as DOMRect).y;
      this.height = window.innerHeight - y;
    },
    listActivistsParameters() {
      var order_field = 'last_event';

      if (this.view === 'leaderboard') {
        order_field = 'total_points';
      } else if (this.view === 'community_prospects') {
        order_field = 'interest_date';
      } else {
        order_field = 'last_event';
      }

      return {
        order: DescOrder,
        order_field: order_field,
        last_event_date_to: this.lastEventDateTo,
        last_event_date_from: this.lastEventDateFrom,
        filter: this.view, // this passes view to the backend, where filtering will now take place
      };
    },
    toggleShowOptions(optionsType: string) {
      if (this.showOptions === optionsType) {
        this.showOptions = '';
      } else {
        this.showOptions = optionsType;
      }
      Vue.nextTick(() => {
        this.setHOTHeight(); // Resize the spreadsheet.
      });
    },
    refreshHOTData() {
      var table = this.hotTable;
      var newSettings = {
        data: rewriteSettings(this.activists),
      };
      table.updateSettings(newSettings, false);
    },
    sortColumn(col: Column) {
      var field = col.data.data;
      if (!field) {
        // Don't sort columsn with no data field (e.g. the first
        // column).
        return;
      }

      var type = col.data.type;
      var sortFunction;
      var ascending = shouldSortByAscending(field, type === 'date');
      if (type === 'date') {
        sortFunction = generateDateSortFn(field, ascending);
      } else if (type === 'numeric') {
        sortFunction = generateGenericSortFn(field, ascending);
      } else if (type === 'checkbox') {
        sortFunction = generateBooleanSortFn(field, ascending);
      } else {
        sortFunction = generateStringSortFn(field, ascending);
      }

      this.allActivists.sort(sortFunction);

      setPreviousSortData(field, ascending);

      this.refreshHOTData();
    },
    afterOnCellMouseDownCallback(event: any, coords: any, td: any) {
      // If the row is -1, then the user clicked on a column header.
      if (coords.row === -1) {
        // To find the column this maps to, we iterate through all the enabled columns.
        var visibleColIndex = coords.col;
        var foundCol;
        for (var i = 0; i < this.columns.length; i++) {
          var col = this.columns[i];
          if (col.enabled) {
            if (visibleColIndex === 0) {
              foundCol = col;
              break;
            }
            visibleColIndex--;
          }
        }
        if (!foundCol) {
          throw new Error('Could not find column at index ' + coords.col);
        }
        this.sortColumn(foundCol);
      }
    },
    // TODO(mdempsky): Remove "this: any".
    debounceSearchInput: debounce(function (this: any, e: Event) {
      this.search = (e.target as HTMLInputElement).value;
    }, 500),
    debounceSearchLocationInput: debounce(function (this: any, e: Event) {
      this.searchLocation = (e.target as HTMLInputElement).value;
    }, 500),
    debounceLocationRadiusInput: debounce(function (this: any, e: Event) {
      this.filterRadius = (e.target as HTMLInputElement).value;
    }, 500),
  },
  data() {
    if (this.view === ('all_activists' || 'leaderboard')) {
      var initDateFrom = initialDateFromValue();
      var initDateTo = initialDateToValue();
    } else {
      var initDateFrom = '';
      var initDateTo = '';
    }

    return {
      root: 'activists-root',
      currentModalName: '',
      activistIndex: -1,
      currentActivist: {} as Activist,
      disableConfirmButton: false,
      allActivists: [] as Activist[],
      height: 500,
      columns: getDefaultColumns(this.view),
      lastEventDateFrom: initDateFrom,
      lastEventDateTo: initDateTo,
      filterInterest: 'All',
      filterRadius: '5',
      showOptions: '',
      search: '',
      searchLocation: '',
      loading: false,
    };
  },
  computed: {
    hotSettings(): object {
      const columns: Handsontable.GridSettings[] = [];
      const columnHeaders: string[] = [];
      for (var i = 0; i < this.columns.length; i++) {
        var col = this.columns[i];
        if (!col.enabled) {
          continue;
        }
        columns.push(this.columns[i].data);
        columnHeaders.push(this.columns[i].header);
      }

      if (this.view === 'development' || this.view === 'organizer_prospects') {
        var fixedCol = 3;
      } else {
        var fixedCol = 0;
      }

      return {
        columns: columns,
        colHeaders: columnHeaders,
        rowHeaders:
          this.view === 'leaderboard' ||
          this.view === 'chapter_member_development' ||
          this.view === 'chapter_member_prospects' ||
          this.view === 'all_activists',
        disableVisualSelection: false,
        multiSelect: true,
        fillHandle: false,
        afterChange: this.afterChangeCallback.bind(this),
        afterOnCellMouseDown: this.afterOnCellMouseDownCallback.bind(this),
        undo: true,
        manualColumnResize: true,
        autoColumnSize: false,
        colWidths: 200,
        viewportRowRenderingOffset: 100,
        viewportColumnRenderingOffset: 20,
        wordWrap: false,
        fixedColumnsLeft: fixedCol, // this causes havoc
      };
    },
    hotTable(): Handsontable {
      return (this.$refs.hot as any).table as Handsontable;
    },
    activists(): Activist[] {
      // This search implementation is slow when we have lots of data.
      // Make it faster when that becomes an issue.

      if (this.search.length < 3 && this.searchLocation.length < 4) {
        // show all
        return this.allActivists;
      } else {
        // prepare for searching
        var searchNameNormalized = this.search.trim().toLowerCase();
        var searchLocNormalized = this.searchLocation.trim();
        var activists: Activist[] = [];
        var filterName = false;
        var filterLoc = false;

        if (this.search.length >= 3) {
          var filterName = true;
        }

        if (this.searchLocation.length >= 4) {
          var filterLoc = true;
          var zipsToCheck = lookupZipcodes(searchLocNormalized);
          var zipcodeRange: any = zipcodeRadius(zipsToCheck, this.filterRadius);
        }

        for (var i = 0; i < this.allActivists.length; i++) {
          var activist = this.allActivists[i];

          // if filterName & filterLoc true, filter by both
          if (filterName && filterLoc) {
            if (
              activist.name.toLowerCase().includes(searchNameNormalized) &&
              zipcodeRange.indexOf(activist.location) !== -1
            ) {
              activists.push(activist);
            }
          }

          // else if filterName is true, filter by it
          else if (filterName) {
            if (activist.name.toLowerCase().includes(searchNameNormalized)) {
              activists.push(activist);
            }
          }

          // else filter by location only
          else {
            if (zipcodeRange.indexOf(activist.location) !== -1) {
              activists.push(activist);
            }
          }
        }

        return activists;
      }
    },
  },
  watch: {
    lastEventDateFrom() {
      this.debounceLoadActivists();
    },
    lastEventDateTo() {
      this.debounceLoadActivists();
    },
    filterInterest() {
      this.loadActivists();
    },
  },
  created() {
    this.loadActivists();
    EventBus.$on('activist-show-options-modal', (row: number) => {
      this.showOptionsModal(row);
    });
    window.addEventListener('resize', () => {
      this.setHOTHeight();
    });
  },
  mounted() {
    this.setHOTHeight();
  },
  updated() {
    var rowCount = this.hotTable.countRows();
    if (rowCount == 0) {
      $('#rowCount').html(String('No data'));
    } else {
      $('#rowCount').html(String(rowCount));
    }
  },
  components: {
    AdbPage,
    HotTable,
  },
  directives: {
    focus,
  },
});
</script>

<style>
.activist-options-body a {
  color: #337ab7;
  cursor: pointer;
}
#activists-root {
  overflow: scroll;
}
.activist-options-btn {
  border: 0;
}
.activist-list-filters {
  margin: 10px 25px;
}
</style>
