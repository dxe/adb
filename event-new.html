<html>
  <head>
  <title>DxE Activist Database</title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" href="awesomplete/awesomplete.css" />
  <script src="awesomplete/awesomplete.js" async></script>
    <script type="text/javascript">
      var CLIENT_ID = '118820662035-o6k1c3k12opp9rp9giearb30mfv871qt.apps.googleusercontent.com';
      var SCOPES = ["https://www.googleapis.com/auth/spreadsheets"];
      // stage:
      var ssID = '1FNZQe2kPOPZeygI_uboTb20EjJmXgJbHDUQQ4O19gKo';
      // prod:
      //var ssID = '106M7H0nEJ9eOi8YePupKB9bZD3rEwqkzgadV_QJh0kI';
      var nextEventCol = "";
      var activistArr = [];
      var totalAttendeeRows = 0;
      var attendeeArr = [];

      // check if user has authorized access to google sheets
      function checkAuth() {
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          },
          handleAuthResult
        );
      }

      // handle response from google auth server
      function handleAuthResult(authResult) {
        var authorizeDiv = document.getElementById('authorize-div');
        var waiting = document.getElementById('waitingforAuth');
        if (authResult && !authResult.error) {
          // Hide auth UI, then load client library.
          authorizeDiv.style.display = 'none';
          waiting.style.display = 'inline';
          loadSheetsApi();
        } else {
          // Show auth UI, allowing the user to initiate authorization by
          // clicking authorize button.
          authorizeDiv.style.display = 'inline';
          waiting.style.display = 'none';
        }
      }

      // initiate authorization when button is clicked
      function handleAuthClick(event) {
        gapi.auth.authorize(
          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
          handleAuthResult);
        return false;
      }

      // load google sheets api
      function loadSheetsApi() {
        var discoveryUrl =
            'https://sheets.googleapis.com/$discovery/rest?version=v4';
        gapi.client.load(discoveryUrl).then(listEvents).then(listActivists)
          .then(function() { addRows(10); });
      }

      // convert column # to A1 notation
      function columnToLetter(column) {
        var temp, letter = '';
        while (column > 0) {
        temp = (column - 1) % 26;
        letter = String.fromCharCode(temp + 65) + letter;
        column = (column - temp - 1) / 26;
        }
      return letter;
      }

      // convert A1 notation to column #
      function letterToColumn(letter) {
        var column = 0, length = letter.length;
        for (var i = 0; i < length; i++) {
          column += (letter.charCodeAt(i) - 64) * Math.pow(26, length - i - 1);
        }
        return column;
      }

      // output list of all activists names
      function listActivists() {
        return gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: ssID,
          range: 'Activist Database!A2:A500',
        }).then(function(response) {
          var range = response.result;
          if (range.values.length > 0) {
            appendPreActivists('Name');
            for (i = 0; i < range.values.length; i++) {
              var row = range.values[i];
              appendPreActivists(row[0]);
              activistArr.push('<option value="' + row[0] + '">' + row[0] + '</option>');
            }
          } else {
            	appendPreActivists('No data found.');
          	}
          var activistArrJoin = activistArr.join("");
          var activistArrString = activistArrJoin.toString();
          document.getElementById("loading-activists").innerHTML = "";
          document.getElementById("attendees").innerHTML = activistArrString; // changed this last
          var mainDiv = document.getElementById('main');
          mainDiv.style.display = 'inline';
        }, function(response) {
          appendPreActivists('Error: ' + response.result.error.message);
        });
      }

      // output list of all activists with status
      function listActivistsStatus() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: ssID,
          range: 'Activist Database!A2:L500',
        }).then(function(response) {
          var range = response.result;
          if (range.values.length > 0) {
            appendPreActivists('Name, Status');
            for (i = 0; i < range.values.length; i++) {
              var row = range.values[i];
              // Print columns A and I, which correspond to indices 0 and 8.
              appendPreActivists(row[0] + ', ' + row[8]);
            }
          } else {
            appendPreActivists('No data found.');
          }
        }, function(response) {
          appendPreActivists('Error: ' + response.result.error.message);
        });
      }

      // output list of all events
      function listEvents() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: ssID,
          range: 'Events Database!B1:ZZ2',
          majorDimension: 'COLUMNS',
        }).then(function(response) {
          var range = response.result;
          if (range.values.length > 0) {
            appendPreEvents('Col, Name, Date');
            for (i = 0; i < range.values.length; i++) {
              var col = range.values[i];
              appendPreEvents(i + ', ' + col[0] + ', ' + col[1]);
              nextEventCol = columnToLetter(i + 3);
            }
          } else {
            appendPreEvents('No data found.');
          }
        }, function(response) {
          appendPreEvents('Error: ' + response.result.error.message);
        });
      }

      // append div element with whatever data
      function appendPreEvents(message) {
        var pre = document.getElementById('events-ouput');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      function appendPreActivists(message) {
        var pre = document.getElementById('activists-output');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      // test for learning correct format to update cells
      function testUpdate(event) {
        gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: ssID,
          range: 'Jake_test!A1:B2',
          valueInputOption: 'USER_ENTERED',
          values: [ ["123","456"],["789","000"] ]
        }).then(function(response) {
            document.getElementById("debug").innerHTML = "Update submited.";
          });
      }

      // creates new event in ADB
      function newEvent(event) {
        var rangeToInsertInto = 'Events Database!' + nextEventCol + '1:200';
        var eventName = document.getElementById('eventName').value;
        if (eventName == "") { alert("Error: Please enter event name!"); }
        var eventDate = document.getElementById('eventDate').value;
        if (eventDate == "") { alert("Error: Please enter date!"); }
        var eventType = document.getElementById('eventType').value;
        attendeeArr = [];
        for (i = 1; i <= totalAttendeeRows; i++) {
        	var attendeeID = 'attendee' + i
        	console.log('ID: ' + attendeeID);
        	var attendeeString = document.getElementById(attendeeID).value;
        	console.log('String: ' + attendeeString);
        	if (attendeeString != "") {
        		attendeeArr.push(attendeeString);
        	}
        }

        var attendeeArr = attendeeArr.filter(function(elem, index, self) {
    		return index == self.indexOf(elem);
		})

        var eventTotal = attendeeArr.length; // need to calculate this
        console.log('attendeeArr: ' + attendeeArr)
        var eventAttendees = attendeeArr; // need to create array from list of names and properly format it
        var valuesArr = [eventName,eventDate,eventTotal,eventType] // TESTING
        var concatArr = valuesArr.concat(attendeeArr);

        if (eventName !== "" && eventDate !== "") {
        	console.log("Event name or date is not blank.")
        	 console.log("Inserting event into: " + rangeToInsertInto);

	        gapi.client.sheets.spreadsheets.values.update({
	          spreadsheetId: ssID,
	          range: rangeToInsertInto,
	          valueInputOption: 'USER_ENTERED',
	          majorDimension: 'COLUMNS',
	          values: [ concatArr ]
	        }).then(function(response) {
	            // what to do after submit button pressed
	          });

        }

      }

      function addRows(numToAdd) {
      	var oldRowTotal = totalAttendeeRows;
      	console.log('Old row total: ' + oldRowTotal)
      	totalAttendeeRows += numToAdd
      	console.log('New row total: ' + totalAttendeeRows)
      	for (i = oldRowTotal + 1; i <= totalAttendeeRows; i++) {
      		console.log('Creating row with ID attendee' + i)
      		var newRow = '<input list="attendees" class="awesomplete" id="attendee' + i + '"  type="text" /><br />';
      		var d = document.getElementById('attendee-rows'); // testing...
      		d.insertAdjacentHTML('beforeend', newRow);
      	} 
      	var a = document.createElement("script");
        a.src = "awesomplete/awesomplete.js";
        document.body.appendChild(a);
      }

    </script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth">
    </script>
  </head>
  <body>
    <div id="menu">
    	<img src="http://dxetech.org/dxe-logo.svg" alt="DxE" width="100" height="100" style="padding-left: 18px;"><br /><br />
    	<span class="menuText"><b>Events</b></span><br />
    	<span class="menuText"><a href="event-new.html">&nbsp;&nbsp;- Add new</a></span><br />
    	<span class="menuText"><a href="event-edit.html">&nbsp;&nbsp;- Edit existing</a></span><br /><br />
    	<span class="menuText"><b>Activists</b></span><br />
    	<span class="menuText"><a href="activist-new.html">&nbsp;&nbsp;- Add new</a></span><br />
    	<span class="menuText"><a href="activist-edit.html">&nbsp;&nbsp;- Edit existing</a></span><br />
    	<span class="menuText"><a href="activist-view.html">&nbsp;&nbsp;- View all</a></span><br /><br />
    </div>
    <div id="bodyWrapper">
    <div id="title">
    	<h1>Create new event</h1>
    </div>
    	<div id="loading-activists">
    		<span id="waitingforAuth"><i>Please wait...</i></span>
    		<div id="authorize-div" style="display:none;">
      			<span>You must authorize access to Google Sheets:</span><br /><br />
      			<button class="button" id="authorize-button" onclick="handleAuthClick(event)">Authorize</button>
    		</div>
    	</span>
    </div>
    <div id="main" style="display:none;">
        <form action="" id="eventForm">
            <label for="eventName"><b>Event name:</b><br /></label>
  			<input id="eventName"><br /><br />

			<label for="eventType"><b>Event type:</b><br /></label>
  			<select id="eventType">
  				<option value="Working Group">Working Group</option>
  				<option value="Community">Community</option>
  				<option value="Protest">Protest</option>
  				<option value="Outreach">Outreach</option>
  				<option value="Key Event">Key Event</option>
			</select>
			<br /><br />

            <label for="eventDate"><b>Event date:</b><br /></label>
  			<input id="eventDate" type="date"><br /><br />

    		<label for="attendee1"><b>Attendees:</b><br /></label>
  			<span id="attendee-rows"></span>

  			<datalist id="attendees">
  			</datalist> 
		</form>

		<button class="button" id="add-rows" onclick="addRows(10)"><span>Add rows</span></button>
		<button class="button" id="submit-button" onclick="newEvent(event)"><span>Save event</span></button>

    	<br /><br />
    	
    	<table style="display:none;">
    		<tr>
    			<td style="vertical-align:top; padding-right:15px;">
      				<h2>All Events</h2>
     				<pre id="events-ouput"></pre>
     			</td>
    			<td style="vertical-align:top; padding-right:15px;">
     				<h2>All Activists</h2>
      				<pre id="activists-output"></pre>
     			</td>
     		</tr>
     	</table>
    </div>

    </div>

    <div id="mobile-menu">
      <p>
        <center>
          <b>Events: </b>
          <a href="event-new.html">&nbsp;&nbsp;- Add new</a>
          <a href="event-edit.html">&nbsp;&nbsp;- Edit existing</a><br />
          <b>Activists: </b>
          <a href="activist-new.html">&nbsp;&nbsp;- Add new</a>
          <a href="activist-edit.html">&nbsp;&nbsp;- Edit existing</a>
          <a href="activist-view.html">&nbsp;&nbsp;- View all</a><br />
        </center>
      </p>
    </div>

  </body>
</html>